# 6.3.16 Payment Plus

### Overview

Payment Plus is a payment method subscribed to by some vendors in which the "payment" to the vendor takes the form of an authorization to charge a dedicated credit card number to receive payment.  The authorizations to the Payment Plus system are handled via an integration that is handled directly from Oracle Financials.

Oracle Financials also handles the crediting of a liability/clearing account for the amount of each payment.  This is a holding location for the funds within the financial system until the funds are actually received by the vendor.  Payment to the Payment Plus bank by UCD is handled via direct-debit by the bank from UCD's bank account.

As vendors charge their cards to receive payment, the bank collects this information and daily sends UCD a file of all the payments which our vendors have processed.  This file includes the payment identifier information (these were the Vnnnnnnn check numbers in KFS) and other information about the transaction.

UCD must process this file to move the funds between two control accounts.  The debit amount is the account credited during the payment process.  The credit represents the cash expended by the University.  The balance in the original clearing account represents un-collected funds owed to vendors, and is used for tracking payment issues.

### High-Level Flow

1. Receive the file from the bank.  This file is in a custom format which will need to be parsed.
2. Extract the needed information about each payment from the file.  (See mapping for details.)
3. Rebuild each transaction into a GL-PPM Journal Flattened format, including the detail information in the glide fields.
4. Create a matching offset transaction for the credit account.
5. Generate the needed attributes on the flowfile.
6. Post the journal to the validated topic for completion and submission to Oracle.

> **NOTE** There is no need for any segment validation in this pipeline.  The entire pipeline uses only two pre-defined GL segment strings.  It is expected that the journal will be summarized down to those two lines by GLIDe before it is sent to Oracle.

### Notes

* <https://community.cloudera.com/t5/Support-Questions/Best-way-to-parse-Fixed-width-file-using-Nifi-Kindly-help/td-p/177637>



## Flow Design

### Design Components

1. Retrieval of file from source Kafka topic.  See section 6.11.
2. Creation of the job data attributes to be used in the flow.
3. Registration of the job in the pipeline_request table.
4. Parsing of the file into useable Avro records.
   1. Only T1 records are needed.  Other lines can be discarded.
   2. Lines are fixed-width/position and will need to be converted to delimited data for processing.  However, only fields of interest must be parsed into fields.  See this article for a method of parsing out the records: <https://community.cloudera.com/t5/Support-Questions/How-to-parse-w-fixed-width-instead-of-char-delimited/td-p/102597>
5. Mapping of the data into the GL-PPM flattened format.  Table below for the mapping.
6. Setting of the standard attributes for GL-PPM validated journals per section 6.2.5.
   1. No segment validation is needed as the segment values are constants provided by the client.
7. Submission of the journal to the validated topic for completion and submission to Oracle.
   1. Standard validated journal processing will handle the needed GLIDe summarization.
8. Generation of a summary of the data in the file and emailing of that report to the consumer ID contact.
   1. This can likely be generated by forking off after the initial data parsing and using QueryRecord to generate the data needed for the report.

> The Excel file in this directory cross references the 1st and 2nd tabs.  Eddie has parsed the file into data elements to reference them in the mappings fields.

### Notes

* Header and trailer lines can be ignored.  (For concur, I just filtered out the header line and threw it away)
* Each line should result in two offsetting transaction lines as per the table below.
* The segment strings may be hard-coded into this process.  If any parameter context values are needed, they should exist within a PC specific to this pipeline.
* The Summary email should contain:
  * Date / timestamp of job run.
  * number of detail records in the input file.
  * total amount of all payments in the file
  * name of input file (source request ID / kafka key)

```txt
Payment Plus File Processed

File Name: 1234567890.txt
Job Run Time: 2019-01-01 12:00:00
Transactions: ${record.count}
Transaction Total Amount: $${transaction.total} (need to ensure this is ###.## somehow)

The above file has been generated and is being submitted to the queue for
processing into GLIDe and Oracle.  A separate email will be received when
the Oracle job has completed.
```

### GL-PPM Mapping

The mapping below is per detail line in the input file.  See Payment Plus File Layout for locations of data.  Values below are the Data ID in that table.  All yyyyMMdd references in the mapping should be replaced with the job run date calculated at the start of the process.

| Column Name                 | Payment Plus Liability        | Cash Offset  | Notes                                  |
| --------------------------- | ----------------------------- | ------------ | -------------------------------------- |
| **Request Header Fields**   |                               |              |                                        |
| `consumerId`                | UCD Payment Plus              | (same)       |                                        |
| `boundaryApplicationName`   | US Bank                       | (same)       |                                        |
| `consumerReferenceId`       | yyyy-MM-dd                    | (same)       |                                        |
| `consumerTrackingId`        | yyyyMMddHHmmss                | (same)       |                                        |
| `consumerNotes`             |                               |              |                                        |
| `requestSourceType`         | sftp                          | (same)       |                                        |
| `requestSourceId`           | yyyyMMddHHmmss                | (same)       |                                        |
| **Journal Header Fields**   |                               |              |                                        |
| `journalSourceName`         | UCD Payment Plus              | (same)       |                                        |
| `journalCategoryName`       | UCD Recharges                 | (same)       |                                        |
| `journalName`               | Payment Plus yyyy-MM-dd       | (same)       |                                        |
| `journalDescription`        |                               |              |                                        |
| `journalReference`          | yyyy-MM-dd                    | (same)       |                                        |
| `accountingDate`            |                               |              |                                        |
| `accountingPeriodName`      |                               |              |                                        |
| **Line Fields**             |                               |              |                                        |
| `debitAmount`               | `<TRANAMT3>`                  |              | Must be converted to 2-decimal places. |
| `creditAmount`              |                               | `<TRANAMT3>` | Must be converted to 2-decimal places. |
| `externalSystemIdentifier`  | `<ORDERNBR>`                  | (same)       |                                        |
| `externalSystemReference`   | PMTPLUS                       | (same)       |                                        |
| `ppmComment`                |                               |              |                                        |
| **GL Segment Fields**       |                               |              |                                        |
| `entity`                    | 3110                          | 3110         |                                        |
| `fund`                      | 13U00                         | 13U00        |                                        |
| `department`                | 1000001                       | 1000002      |                                        |
| `account`                   | 238611                        | 100032       |                                        |
| `purpose`                   | 00                            | 00           |                                        |
| `program`                   | 000                           | 000          |                                        |
| `glProject`                 | 0000000000                    | 0000000000   |                                        |
| `activity`                  | 000000                        | 000000       |                                        |
| `interEntity`               | 0000                          | 0000         |                                        |
| `flex1`                     | 000000                        | 000000       |                                        |
| `flex2`                     | 000000                        | 000000       |                                        |
| **PPM Segment Fields**      |                               |              |                                        |
| `ppmProject`                |                               |              |                                        |
| `task`                      |                               |              |                                        |
| `organization`              |                               |              |                                        |
| `expenditureType`           |                               |              |                                        |
| `award`                     |                               |              |                                        |
| `fundingSource`             |                               |              |                                        |
| **Internal Control Fields** |                               |              |                                        |
| `lineType`                  | glSegments                    | (same)       |                                        |
| **GLIDe Fields**            |                               |              |                                        |
| `lineDescription`           | `<BATCH_NBR><TRANID><SUPLID>` | (same)       |                                        |
| `journalLineNumber`         |                               |              |                                        |
| `transactionDate`           |                               |              |                                        |
| `udfNumeric1`               | `<SALSTAX3>`                  | (same)       |                                        |
| `udfNumeric2`               |                               |              |                                        |
| `udfNumeric3`               |                               |              |                                        |
| `udfDate1`                  | `<TRANDT>`                    | (same)       |                                        |
| `udfDate2`                  | yyyyMMdd                      | (same)       |                                        |
| `udfString1`                | `<MERCHVNM>`                  | (same)       |                                        |
| `udfString2`                | `<MERCHCITY>, <MERCHST>`      | (same)       |                                        |
| `udfString3`                | `<ORDERNBR>`                  | (same)       |                                        |
| `udfString4`                | PMTPLUS                       | (same)       |                                        |
| `udfString5`                | `<BATCH_NBR><TRANID><SUPLID>` | (same)       |                                        |

* Amounts in the file use an implicit decimal point.  For example, 1000 is $10.00.  This must be converted to a decimal value with 2 decimal places.

### Cleaning Up Data Types

TO ensure we match the schema, we need to clean up the data types in the records to make appropriate ones numeric, and to null out ones we are not using.

```groovy
// Look over all fields, replacing any that are an empty string with null
for ( String field : record.getRawFieldNames() ) {
  if ( record.getValue( field ) == "" ) {
    record.setValue( field, null )
  }
}
// for numeric fields, replace the string with a BigDecimal if it is not null
for ( String field : [ "debitAmount", "creditAmount", "udfNumeric1" ] ) {
  if ( record.getValue( field ) != null ) {
    record.setValue( field, new BigDecimal( record.getValue( field ) ) )
  }
}
return record;
```


## Payment Plus File Layout

> For reference when setting up the parsing logic for this file format.

| Data ID           | Data Name | Content Type | Content Notes                                      |
| ----------------- | --------- | ------------ | -------------------------------------------------- |
| **HEADER RECORD** |           |              |                                                    |
| HEADER_ID         |           | HARD-CODE    | HEADER_ID/A8 WITH ACCT_NBR='**HEADER';             |
| FEED_CD           |           | HARD-CODE    | FEED_CD/A2='VP';                                   |
| FEED_CD_NM        |           | HARD-CODE    | FEED_CD_NM/A15='VENDPMTPLUS-USB';                  |
| BATCH_NBR         |           | BATCH#       | BATCH_NBR/A14=EDIT('&BATCH_NBR','99999999999999'); |
| EMPTY             |           | BLANK        | EMPTY/A1=' ';                                      |
| FILLER1           |           | BLANK        | FILLER1/A250=' ';                                  |
| FILLER2           |           | BLANK        | FILLER2/A146=' ';                                  |

| Data ID           | Data Name                    | Content Type          | Content Notes                                         |
| ----------------- | ---------------------------- | --------------------- | ----------------------------------------------------- |
| **DETAIL RECORD** |                              |                       |                                                       |
| RECORD_TYPE       |                              | HARD-CODE             | RECORD_TYPE/A2 = 'T1';                                |
| FEED_CD           |                              | HARD-CODE             | FEED_CD/A2 = 'VP';                                    |
| BATCH_NBR         |                              | BATCH#                | BATCH_NBR/A14 = EDIT('&BATCH_NBR','99999999999999');  |
| TRANID            |                              | JULIAN DATE+SEQUENCE# | A10 / Example: `2223000001`                           |
|                   |                              |                       | Jul Date: `22230` Seq #: `00001`                      |
| SUPLID            | CLIENT SUPPLEMENTAL ID       |                       | SUPLID/A25 = CLNT_SUPL_ID; Example: `0000013880-0014` |
| CHNAME            | MERCHANT NAME                |                       | CHNAME/A40 = MERCH_NM;                                |
| ADDRLN1           | MERCHANT ADDR1               |                       | ADDRLN1/A40 = ADDR_LN1;                               |
| CHCITY            | ORDER MERCHANT CITY          |                       | CHCITY/A40 = ORDER_MERCH_CITY;                        |
| CHSTATE           | MERCHANT STATE               |                       | CHSTATE/A2 = EDIT(MERCH_ST_CDE,'99$');                |
| CHZIP             | MERCHANT POSTAL CODE         |                       | CHZIP/A11  = EDIT(MERCH_PSTL_CDE,'99999999999$');     |
| IMERCHMCC         | MERCHANT CATEGORY CODE       |                       | IMERCHMCC/I4L = MERCH_MCC_CDE;                        |
| MERCHID           | MERCHANT ID                  |                       | MERCHID/A15   = EDIT(MERCH_ID,'$999999999999999');    |
| MERCHVNM          | MERCHANT VISA NAME           |                       | MERCHVNM/A40   = MERCH_VISA_NM;                       |
| MERCHADDR1        | BLANK                        |                       | MERCHADDR1/A40 = ' ';                                 |
| MERCHCITY         | MERCHANT CITY                |                       | MERCHCITY/A40 = MERCH_CITY;                           |
| MERCHST           | MERCHANT STATE CODE          |                       | MERCHST/A2    = EDIT(MERCH_ST_CDE,'99$');             |
| MERCHPSTL         | MERCHANT POSTAL CODE         |                       | MERCHPSTL/A11 = MERCH_PSTL_CDE;                       |
| MINORITY          | BLANK                        |                       | MINORITY/A1 = ' ';                                    |
| MERCHTAX          | BLANK                        |                       | MERCHTAX/A9 = ' ';                                    |
| ORDERNBR          | ORDER NUMBER                 |                       | ORDERNBR/A25  = ORDER_NBR;                            |
| TRANDT            | TRANSACTION TRAN DATE        |                       | TRANDT/A8YYMD = TRANS_DT;                             |
| PSTDT             | TRANSACTION POSTING DATE     |                       | PSTDT/A8YYMD = PST_DT;                                |
| TRANS_REF_NBR     | TRANSACTION REFERENCE NUMBER |                       | TRANS_REF_NBR                                         |
| SALSTAX3          | SALES TAX                    |                       | "SALS_TAX/D15.2L = SLS_TAX_AMT;                       |
| TRANAMT3          | TRAN AMOUNT                  |                       | "TRAN_AMT/D15.2L = TRANS_AMT;                         |

| Data ID            | Data Name    | Content Type | Content Notes             |
| ------------------ | ------------ | ------------ | ------------------------- |
| **TRAILER RECORD** |              |              |                           |
| HEADER_ID          | HARD-CODE    |              | HEADER_ID/A9='**TRAILER'; |
| FEED_CD            | HARD-CODE    |              | FEED_CD/A2='VP';          |
| RCNTO              | RECORD COUNT |              | RCNTO/I6L = RECCNT;       |
| TRANAMTC           | TOTAL AMOUNT |              | D15.2                     |
| FILLER             | BLANK        |              | FILLER/A207=' ';          |
| FILL2              | BLANK        |              | FILL2/A200=' ';           |

> Note that all amounts in the file have an assumed 2 decimal places.  During generation, all amounts will need to be divided by 100.

### Regular Expressions for Parsing Detail Records

> These expressions are used to extract the position data from the file.  Each works to ignore the first X characters of a line, then capture the next Y characters.

| Attribute Name | Regular Expression        | Notes |
| -------------- | ------------------------- | ----- |
| pstdt          | `"(?s)^.{381}(.{8}).*"`   |       |
| salstax3       | `"(?s)^.{412}(.{12}).*"`  |       |
| tranamt3       | `"(?s)^.{424}(.{12,})"`   |       |
| chcity         | `"(?s)^.{133}(.{40}).*"`  |       |
| chstate        | `"(?s)^.{173}(.{2}).*"`   |       |
| addrln1        | `"(?s)^.{93}(.{40}).*"`   |       |
| minority       | `"(?s)^.{338}(.{1}).*"`   |       |
| merchid        | `"(?s)^.{190}(.{15}).* "` |       |
| merchaddr1     | `"(?s)^.{245}(.{40}).*"`  |       |
| trans_ref_nbr  | `"(?s)^.{389}(.{23}).*"`  |       |
| batch_nbr      | `"(?s)^.{4}(.{14}).*"`    |       |
| suplid         | `"(?s)^.{28}(.{25}).*"`   |       |
| trandt         | `"(?s)^.{373}(.{8}).*"`   |       |
| tranid         | `"(?s)^.{18}(.{10}).*"`   |       |
| ordernbr       | `"(?s)^.{348}(.{25}).*"`  |       |
| merchpstl      | `"(?s)^.{327}(.{11}).*"`  |       |
| imerchmcc      | `"(?s)^.{186}(.{4}).* "`  |       |
| chname         | `"(?s)^.{53}(.{40}).*"`   |       |
| merchtax       | `"(?s)^.{339}(.{9}).*"`   |       |
| record_type    | `"(?s)(^.{2}).*"`         |       |
| feed_cd        | `"(?s)^.{2}(.{2}).*"`     |       |
| merchcity      | `"(?s)^.{285}(.{40}).*"`  |       |
| merchvnm       | `"(?s)^.{205}(.{40}).* "` |       |
| merchst        | `"(?s)^.{325}(.{2}).*"`   |       |
| chzip          | `"(?s)^.{175}(.{11}).*"`  |       |
