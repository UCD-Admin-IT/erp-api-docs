# 6.3.18 AR Lockbox


#### Summary

The AR Receipting Lockbox files (in Oracle Extended BAI2 format) will be obtained from banks and put into an AWS S3 bucket. Newly created data files will be published to a Kafka topic for consumption. The AR Lockbox custom pipeline will fetch the lockbox files from the Kafka topic and then submit them to Oracle ERP Integration API for processing.


#### Overall Process

1. Fetch lockbox file data from the Kafka topic `in.<env>.sftp.dat.arLockbox`. The lockbox ID will be embedded in the message key.
2. Prepare the file content for posting to Oracle ERP Integration API (see [ESS Job Parameters](#ESS Job Parameters) for details).
   * File names must be prefixed with `arlockboximportextbai2`
   * Lockbox ID need to be translated to Oracle internal lockbox ID
   * Business unit need to be translated to Oracle internal ORG ID
3. Post the prepared lockbox file to Integration API using SOAP.


#### SOAP API Request

```XML
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns2="http://xmlns.oracle.com/apps/financials/commonModules/shared/model/erpIntegrationService/">
    <soap:Body>
        <importBulkData xmlns="http://xmlns.oracle.com/apps/financials/commonModules/shared/model/erpIntegrationService/types/">
            <document>
                <ns2:Content>{{payload}}</ns2:Content>
                <ns2:FileName>ARLOCKBOX_{{lockboxNumber}}_{{groupId}}.zip</ns2:FileName>
            </document>
            <jobDetails>
                <ns2:JobName>oracle/apps/ess/financials/receivables/receipts/lockboxes,ProcessLockboxesMasterEss</ns2:JobName>
                <ns2:ParameterList>{{parameterList}}</ns2:ParameterList>
            </jobDetails>
            <notificationCode>00</notificationCode>
            <jobOptions>ExtractFileType=ALL</jobOptions>
        </importBulkData>
    </soap:Body>
</soap:Envelope>
```


#### ESS Job Parameters

| Position | Description                    | Required | Value                                    | Notes                                           |
| -------- | ------------------------------ | -------- | ---------------------------------------- | ----------------------------------------------- |
| 1        | New Transmission               | Yes      | Y                                        | Is new transmission?                            |
| 2        | Original Request ID            | No       | `{req_id}`                               | Placeholder for parent process ID               |
| 3        | Transmission Name              | Yes      | `ARLOCKBOX_{lockboxNumber}_{YYYYMMDDhhmmss}` |                                                 |
| 4        | Submit Import                  | Yes      | N                                        | Import data file and control file?              |
| 5        | Data File                      | No       | #NULL                                    |                                                 |
| 6        | Control File                   | No       | #NULL                                    |                                                 |
| 7        | Transmission Format ID         | No       | 108                                      | ORA-BAI2-Extended format                        |
| 8        | Submit Validation              | Yes      | Y                                        | Validate data?                                  |
| 9        | Lockbox ID                     | No       | (from lookup table)                      | The internal lockbox ID generated by Oracle     |
| 10       | Accounting Date                | No       | `${now():format('yyyy-MM-dd')}`          |                                                 |
| 11       | Report Format                  | Yes      | A                                        | All format                                      |
| 12       | Complete Batches Only          | Yes      | N                                        |                                                 |
| 13       | Pay Unrelated Invoices         | Yes      | N                                        |                                                 |
| 14       | Allow Invalid Trx Number       | Yes      | N                                        |                                                 |
| 15       | Submit Post Receipts           | Yes      | Y                                        | Automatically post receipt after job submission |
| 16       | Business Unit                  | Yes      | (from lookup table)                      | The internal ORG ID generated by Oracle         |
| 17       | Instances to Process AutoApply | Yes      | 1                                        | Number of worker processors                     |


#### Oracle-BAI2-Extended File Examples

[UCD Campus](#/6%20Data%20Pipelines/6.3%20Custom%20Pipelines/6.3.18%20AR%20Lockbox/arlockboximportextbai2_741816.sample.txt/HOME ':ignore')
[UCD CGA](#/6%20Data%20Pipelines/6.3%20Custom%20Pipelines/6.3.18%20AR%20Lockbox/arlockboximportextbai2_743739.sample.txt/HOME ':ignore')


#### Lockbox ID Mappings

A lookup table in the integration database, named `ar_lockbox`, will provide the information of lockbox ID mappings. This table will be periodically updated by the `Oracle Data Extracts` pipeline. Here's the column definition for that table:

| Column Name       | Data Type   | Notes                       |
| ----------------- | ----------- | --------------------------- |
| LOCKBOX_ID        | numeric(18) | Oracle internal lockbox ID  |
| ORG_ID            | numeric(18) | Oracle internal org ID      |
| LOCKBOX_NUMBER    | varchar(30) | UCD assigned lockbox number |
| LAST_UPDATE_LOGIN | varchar(30) | Oracle internal login ID    |
| LAST_UPDATE_DATE  | timestamptz | Last update timestamp       |


#### Nifi Parameter Context

* `pipeline_id`: `ar_lockbox`
* `submit_pipeline_id`: `ar_lockbox`
* `consumer_id`: `UCD AR Lockbox`
* `lockbox_mappings`: static mappings of Oracle Org ID and Lockbox ID to UCD Lockbox ID (need to be configured per environment), e.g.

  ```groovy
  def oracleLockboxId = [
      '741816': '300000006685930',
      '743739': '300000013440524',
  ]
  def oracleBusinessUnit = [
      '741816': '300000003955478',
      '743739': '300000004208318',
  ]
  ```

#### Nifi Flowfile Attributes

| Processor Name            | Attribute Name      | Attribute Value                                           | Description                                               |
| ------------------------- | ------------------- | --------------------------------------------------------- | --------------------------------------------------------- |
| Get Lockbox Files         | kafka.key           | (Regex: `.+arlockboximportextbai2_\d[6]_\d[14].txt`)      | AR lockbox file name with lockbox ID embedded             |
| Set Job Attributes        | accounting.date     | `${now():format('yyyy-MM-dd')}`                           | Accounting date                                           |
| Set Job Attributes        | assigned.job.id     | `${now():toNumber()}`                                     | Unique ID for each job                                    |
| Set Job Attributes        | data.source         | sftp                                                      | Data source                                               |
| Set Job Attributes        | job.definition.name | ProcessLockboxesMasterEss                                 | Java class name of lockbox processing job                 |
| Set Job Attributes        | job.package.name    | oracle/apps/ess/financials/receivables/receipts/lockboxes | Java package name of ProcessLockboxesMasterEss class      |
| Set Job Attributes        | job.id              | ar_lockbox                                                | Pipeline request job ID                                   |
| Set Job Attributes        | source.name         | `#{consumer_id}`                                          | Data source name                                          |
| Set Oracle Job Parameters | lockboxId           | (derived from `kafka.key` attribute)                      | UCD AR Lockbox ID                                         |
| Set Oracle Job Parameters | filename            | (derived from `kafka.key` attribute)                      | Lockbox file name prefixing with `arlockboximportextbai2` |
| Set Oracle Job Parameters | job.parameter.list  | (derived from `lockboxId` attribute)                      | Oracle Process Lockbox ESS job parameter list             |


#### Groovy Scripts

[Set Oracle Job Parameters](#/6%20Data%20Pipelines/6.3%20Custom%20Pipelines/6.3.18%20AR%20Lockbox/6.3.18.A%20Groovy%20Scripts/set-oracle-job-params.groovy/HOME ':ignore')
[Compress and Encode File Content](#/6%20Data%20Pipelines/6.3%20Custom%20Pipelines/6.3.18%20AR%20Lockbox/6.3.18.A%20Groovy%20Scripts/compress-encode-file.groovy/HOME ':ignore')
